#include "vuart.h"
#include "gpio.h"
#include "dispctrl.h"
#include "ppu.h"

// Render a 1-wide max-height frame.

#define FRAME_HEIGHT 512

// u32 because this is actually FRAME_HEIGHT individual pixels, and PPU base
// addresses are 32-bit aligned.
static const uint32_t sprite[FRAME_HEIGHT] = {
	0x8000, 0x8001, 0x8002, 0x8003, 0x8004, 0x8005, 0x8006, 0x8007, 0x8008,
	0x8009, 0x800a, 0x800b, 0x800c, 0x800d, 0x800e, 0x800f, 0x8010, 0x8011,
	0x8012, 0x8013, 0x8014, 0x8015, 0x8016, 0x8017, 0x8018, 0x8019, 0x801a,
	0x801b, 0x801c, 0x801d, 0x801e, 0x801f, 0x8020, 0x8021, 0x8022, 0x8023,
	0x8024, 0x8025, 0x8026, 0x8027, 0x8028, 0x8029, 0x802a, 0x802b, 0x802c,
	0x802d, 0x802e, 0x802f, 0x8030, 0x8031, 0x8032, 0x8033, 0x8034, 0x8035,
	0x8036, 0x8037, 0x8038, 0x8039, 0x803a, 0x803b, 0x803c, 0x803d, 0x803e,
	0x803f, 0x8040, 0x8041, 0x8042, 0x8043, 0x8044, 0x8045, 0x8046, 0x8047,
	0x8048, 0x8049, 0x804a, 0x804b, 0x804c, 0x804d, 0x804e, 0x804f, 0x8050,
	0x8051, 0x8052, 0x8053, 0x8054, 0x8055, 0x8056, 0x8057, 0x8058, 0x8059,
	0x805a, 0x805b, 0x805c, 0x805d, 0x805e, 0x805f, 0x8060, 0x8061, 0x8062,
	0x8063, 0x8064, 0x8065, 0x8066, 0x8067, 0x8068, 0x8069, 0x806a, 0x806b,
	0x806c, 0x806d, 0x806e, 0x806f, 0x8070, 0x8071, 0x8072, 0x8073, 0x8074,
	0x8075, 0x8076, 0x8077, 0x8078, 0x8079, 0x807a, 0x807b, 0x807c, 0x807d,
	0x807e, 0x807f, 0x8080, 0x8081, 0x8082, 0x8083, 0x8084, 0x8085, 0x8086,
	0x8087, 0x8088, 0x8089, 0x808a, 0x808b, 0x808c, 0x808d, 0x808e, 0x808f,
	0x8090, 0x8091, 0x8092, 0x8093, 0x8094, 0x8095, 0x8096, 0x8097, 0x8098,
	0x8099, 0x809a, 0x809b, 0x809c, 0x809d, 0x809e, 0x809f, 0x80a0, 0x80a1,
	0x80a2, 0x80a3, 0x80a4, 0x80a5, 0x80a6, 0x80a7, 0x80a8, 0x80a9, 0x80aa,
	0x80ab, 0x80ac, 0x80ad, 0x80ae, 0x80af, 0x80b0, 0x80b1, 0x80b2, 0x80b3,
	0x80b4, 0x80b5, 0x80b6, 0x80b7, 0x80b8, 0x80b9, 0x80ba, 0x80bb, 0x80bc,
	0x80bd, 0x80be, 0x80bf, 0x80c0, 0x80c1, 0x80c2, 0x80c3, 0x80c4, 0x80c5,
	0x80c6, 0x80c7, 0x80c8, 0x80c9, 0x80ca, 0x80cb, 0x80cc, 0x80cd, 0x80ce,
	0x80cf, 0x80d0, 0x80d1, 0x80d2, 0x80d3, 0x80d4, 0x80d5, 0x80d6, 0x80d7,
	0x80d8, 0x80d9, 0x80da, 0x80db, 0x80dc, 0x80dd, 0x80de, 0x80df, 0x80e0,
	0x80e1, 0x80e2, 0x80e3, 0x80e4, 0x80e5, 0x80e6, 0x80e7, 0x80e8, 0x80e9,
	0x80ea, 0x80eb, 0x80ec, 0x80ed, 0x80ee, 0x80ef, 0x80f0, 0x80f1, 0x80f2,
	0x80f3, 0x80f4, 0x80f5, 0x80f6, 0x80f7, 0x80f8, 0x80f9, 0x80fa, 0x80fb,
	0x80fc, 0x80fd, 0x80fe, 0x80ff, 0x8100, 0x8101, 0x8102, 0x8103, 0x8104,
	0x8105, 0x8106, 0x8107, 0x8108, 0x8109, 0x810a, 0x810b, 0x810c, 0x810d,
	0x810e, 0x810f, 0x8110, 0x8111, 0x8112, 0x8113, 0x8114, 0x8115, 0x8116,
	0x8117, 0x8118, 0x8119, 0x811a, 0x811b, 0x811c, 0x811d, 0x811e, 0x811f,
	0x8120, 0x8121, 0x8122, 0x8123, 0x8124, 0x8125, 0x8126, 0x8127, 0x8128,
	0x8129, 0x812a, 0x812b, 0x812c, 0x812d, 0x812e, 0x812f, 0x8130, 0x8131,
	0x8132, 0x8133, 0x8134, 0x8135, 0x8136, 0x8137, 0x8138, 0x8139, 0x813a,
	0x813b, 0x813c, 0x813d, 0x813e, 0x813f, 0x8140, 0x8141, 0x8142, 0x8143,
	0x8144, 0x8145, 0x8146, 0x8147, 0x8148, 0x8149, 0x814a, 0x814b, 0x814c,
	0x814d, 0x814e, 0x814f, 0x8150, 0x8151, 0x8152, 0x8153, 0x8154, 0x8155,
	0x8156, 0x8157, 0x8158, 0x8159, 0x815a, 0x815b, 0x815c, 0x815d, 0x815e,
	0x815f, 0x8160, 0x8161, 0x8162, 0x8163, 0x8164, 0x8165, 0x8166, 0x8167,
	0x8168, 0x8169, 0x816a, 0x816b, 0x816c, 0x816d, 0x816e, 0x816f, 0x8170,
	0x8171, 0x8172, 0x8173, 0x8174, 0x8175, 0x8176, 0x8177, 0x8178, 0x8179,
	0x817a, 0x817b, 0x817c, 0x817d, 0x817e, 0x817f, 0x8180, 0x8181, 0x8182,
	0x8183, 0x8184, 0x8185, 0x8186, 0x8187, 0x8188, 0x8189, 0x818a, 0x818b,
	0x818c, 0x818d, 0x818e, 0x818f, 0x8190, 0x8191, 0x8192, 0x8193, 0x8194,
	0x8195, 0x8196, 0x8197, 0x8198, 0x8199, 0x819a, 0x819b, 0x819c, 0x819d,
	0x819e, 0x819f, 0x81a0, 0x81a1, 0x81a2, 0x81a3, 0x81a4, 0x81a5, 0x81a6,
	0x81a7, 0x81a8, 0x81a9, 0x81aa, 0x81ab, 0x81ac, 0x81ad, 0x81ae, 0x81af,
	0x81b0, 0x81b1, 0x81b2, 0x81b3, 0x81b4, 0x81b5, 0x81b6, 0x81b7, 0x81b8,
	0x81b9, 0x81ba, 0x81bb, 0x81bc, 0x81bd, 0x81be, 0x81bf, 0x81c0, 0x81c1,
	0x81c2, 0x81c3, 0x81c4, 0x81c5, 0x81c6, 0x81c7, 0x81c8, 0x81c9, 0x81ca,
	0x81cb, 0x81cc, 0x81cd, 0x81ce, 0x81cf, 0x81d0, 0x81d1, 0x81d2, 0x81d3,
	0x81d4, 0x81d5, 0x81d6, 0x81d7, 0x81d8, 0x81d9, 0x81da, 0x81db, 0x81dc,
	0x81dd, 0x81de, 0x81df, 0x81e0, 0x81e1, 0x81e2, 0x81e3, 0x81e4, 0x81e5,
	0x81e6, 0x81e7, 0x81e8, 0x81e9, 0x81ea, 0x81eb, 0x81ec, 0x81ed, 0x81ee,
	0x81ef, 0x81f0, 0x81f1, 0x81f2, 0x81f3, 0x81f4, 0x81f5, 0x81f6, 0x81f7,
	0x81f8, 0x81f9, 0x81fa, 0x81fb, 0x81fc, 0x81fd, 0x81fe, 0x81ff
};

ppu_instr_t prog[1024];

int main() {
	gpio_hw->fsel_set = 0xffu << GPIO_LCD_DAT0;
	dispctrl_set_parallel_mode(true);
	dispctrl_set_half_rate(false);
	dispctrl_set_shift_width(16);
	dispctrl_set_scanbuf_size(1);
	dispctrl_force_dc_cs(1, 0);
	dispctrl_set_scan_enabled(true);

	vuart_puts("Generating PPU program\n");
	ppu_instr_t *p = &prog[0];
	p += cproc_clip(p, 0, 0);
	for (int i = 0; i < FRAME_HEIGHT; ++i) {
		p += cproc_blit(p, 0, i, PPU_SIZE_8, 0, PPU_FORMAT_ARGB1555, &sprite[i]);
		p += cproc_sync(p);
	}

	vuart_puts("Starting PPU\n");
	cproc_put_pc(&prog[0]);
	ppu_set_display_w_h(1, FRAME_HEIGHT);
	ppu_start(true);

	while (ppu_is_running())
		;
	dispctrl_wait_idle();

	vuart_puts("Done\n");
	vuart_puts("!TPASS");
}
